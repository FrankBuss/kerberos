
#include <stdint.h>
#include <stddef.h>
#include <string.h>
#include "efmenu.h"
#include "image_detect.h"

#define ROML ((uint8_t*) 0x8000)

image_fingerprint_t kernal_signatures[] =
{
    /* offset   signature       name */
    { 0x0400,   { 0x86, 0x16, 0x38, 0xae, 0x81, 0x02, 0xac, 0x82 }, "Commodore MAX" },
    { 0x0449,   { 0x2e, 0xf7, 0x7c, 0xa5, 0x1a, 0xa7, 0xe4, 0xa7 }, "Commodore C64 Games System" },
    { 0x0477,   { 0x4f, 0x20, 0x52, 0x4f, 0x4d, 0x20, 0x49, 0x49 }, "Datel TurboROM II" },
    { 0x0477,   { 0x55, 0x52, 0x59, 0x2d, 0x52, 0x4f, 0x4d, 0x20 }, "Datel Mercury ROM 3" },
    { 0x047c,   { 0x4a, 0x49, 0x46, 0x46, 0x59, 0x44, 0x4f, 0x53 }, "Jiffy DOS" },
    { 0x047e,   { 0x54, 0x54, 0x2d, 0x52, 0x4f, 0x4d, 0x20, 0x2f }, "Turbo Tape" },
    { 0x0481,   { 0x53, 0x58, 0x2d, 0x36, 0x34, 0x20, 0x42, 0x41 }, "Commodore SX-64" },
    { 0x0482,   { 0x54, 0x55, 0x52, 0x42, 0x4f, 0x2d, 0x50, 0x52 }, "TurboProcess" },
    { 0x0487,   { 0x34, 0x30, 0x20, 0x54, 0x52, 0x41, 0x43, 0x4b }, "SpeedDOS Plus 40 Tracks" },
    { 0x0487,   { 0x42, 0x45, 0x41, 0x53, 0x54, 0x20, 0x53, 0x59 }, "The Beast System" },
    { 0x0489,   { 0x54, 0x55, 0x52, 0x42, 0x4f, 0x2d, 0x41, 0x43 }, "TurboAccess" },
    { 0x048a,   { 0x50, 0x52, 0x4f, 0x46, 0x45, 0x53, 0x53, 0x49 }, "Professional DOS" },
    { 0x048b,   { 0x54, 0x55, 0x52, 0x42, 0x4f, 0x20, 0x54, 0x52 }, "Turbo Trans" },
    { 0x048d,   { 0x45, 0x58, 0x4f, 0x53, 0x20, 0x56, 0x33, 0x20 }, "EXOS V3" },
    { 0x049b,   { 0x44, 0x4f, 0x4c, 0x50, 0x48, 0x49, 0x4e, 0x44 }, "Dolphin DOS" }, /* 2.0, 2.1 */
    { 0x049b,   { 0x50, 0x52, 0x4f, 0x4c, 0x4f, 0x47, 0x49, 0x43 }, "Prologic System" },
    { 0x049b,   { 0x53, 0x54, 0x41, 0x52, 0x44, 0x4f, 0x53, 0x20 }, "StarDOS" },
    { 0x049d,   { 0x27, 0x45, 0x52, 0x20, 0x53, 0x59, 0x53, 0x54 }, "64'er System V3" },
    { 0x04a4,   { 0x20, 0x50, 0x4c, 0x55, 0x53, 0x20, 0x20, 0x00 }, "SpeedDOS Plus" },
    { 0x04a4,   { 0x45, 0x20, 0x37, 0x36, 0x20, 0x2d, 0x20, 0x00 }, "SpeedDOS Plus Improved" },
    { 0x04a4,   { 0x50, 0x4c, 0x55, 0x53, 0x2b, 0x20, 0x20, 0x00 }, "SpeedDOS Plus+" },
    { 0x0a07,   { 0x20, 0xda, 0xe4, 0xa9, 0x20, 0x91, 0xd1, 0x88 }, "Commodore 64 Rev. 3" },
    { 0x0a07,   { 0xa9, 0x20, 0x91, 0xd1, 0x20, 0xda, 0xe4, 0xea }, "Commodore 64 Rev. 2" },
    { 0x0a07,   { 0xa9, 0x20, 0x91, 0xd1, 0xa9, 0x01, 0x91, 0xf3 }, "Commodore 64 Rev. 1" },

    { 0xffff, {0, 0, 0, 0, 0, 0, 0, 0}, NULL } /* end mark */
};


void detect_images(efmenu_entry_t* kernal_menu)
{
    char found;
    efmenu_entry_t* entry;
    image_fingerprint_t* fp;

    entry = kernal_menu;
    while (entry->key)
    {
        set_bank(entry->bank);
        fp = kernal_signatures;
        found = 0;
        while (fp->offset != 0xffff)
        {
            if (memcmp(ROML + fp->offset, fp->signature,
                       IMAGE_SIGNATURE_LEN) == 0)
            {
                entry->name = fp->name;
                found = 1;
                break;
            }
            ++fp;
        }
        if (!found && ((ROML[0x1ffc] != 0xff) || (ROML[0x1ffd] != 0xff)))
        {
            entry->name = "Unknown KERNAL";
        }
        ++entry;
    }
}
